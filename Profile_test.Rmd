---
title: "profile_test"
author: "Karen"
date: "2017年4月13日"
output: html_document
---


## Basic
```{R}

#匯入profile data
data = read.csv("E:/hackathon-encoded/profile/partition_time=3696969600/part-00000-74cda679-a63c-4af7-8c30-cf0a24a44e8f.csv",header = F)
head(data)
#帶入Header
colnames(data) = c('PID','Birthday','Gender','Comm_Area','Comm_Areacode','House_Area','House_AreaCode','BOA','Rev','Date_Arrival','Credit_Card','Loan','Saving','FM','Data_Date')
str(data)
as.data.frame(data)



#變更類別變數

data$Gender_f <- factor(data$Gender, levels = c("F","M",""), labels = c("0","1","2"))
data$Credit_Card_f <- factor(data$Credit_Card, levels = c("N","Y"), labels = c("0","1"))
data$Loan_f <- factor(data$Loan, levels = c("N","Y"), labels = c("0","1"))
data$Saving_f <- factor(data$Saving, levels = c("N","Y"), labels = c("0","1"))
data$FM_f <- factor(data$FM, levels = c("N","Y"), labels = c("0","1"))
str(data)


#使用attach函數，建立與data資料集的連結，之後就可直接使用變數名稱來操作
###注意attach只是目前資料集的快照(snapshot),若原始資料有更動,attach中的資料不會跟著變動
#attach(data)
round(mean(data$BOA))
options(scipen=999)
summary(data)


#檢查Null、NA值，Gender有一空值，Comm_Areacode等有NA暫不處理
which(data$Gender_f == "2")
#將刪除Gender空值後的data指定為data1
data1 <- data[-28139,]
```

##DATA樣貌
```{R}

#相關係數
cor_BOARev = cov(data1$BOA,data1$Rev) / (sd(data1$BOA) * sd(data1$Rev))  
cor_BOARev
cor.test(data1$BOA,data1$Rev)

#一維次數分配表
table(data1$Gender)

#相對比例
options(digits =1) 
(table(data1$Gender) / nrow(data1))*100

#二維次數分配表(以性別_辦卡為例)
table_GC = table(data1$Gender,data1$Credit_Card)
margin.table(table_GC, 1) #男女性人數
margin.table(table_GC, 2) #是否辦卡的人數

#二維比列表(以性別_辦卡為例)
options(digits=2,scipen=999) #digits=2→小數點後2位 ； scipen=999→取消科學記號
(prop.table(table_GC,1))*100 #看出女性辦卡比率較高

#連續型資料作表
options(scipen=999)
table(data1$BOA)
summary(data1$BOA)
#table(cut(data1$BOA,seq(2310336000,3696796800,by=100000000)))


#客戶近三個月平均總資產餘額(BOA)
sd(data1$BOA)
var(data1$BOA)
op<-par(mfrow=c(1,1))
hist(data1$BOA,breaks=50,main="BOA分配圖",xlab="BOA")
```

##統計圖
```{R}

#圓餅圖
op<-par(mfrow=c(3,2))
pie(table(data1$Gender),main="性別",radius=1)
pie(table(data1$Credit_Card),main="是否有信用卡",radius=1)
pie(table(data1$Loan),main="是否有貸款",radius=1)
pie(table(data1$Saving),main="是否有存款",radius=1)
pie(table(data1$FM),main="是否有理財",radius=1)
op<-par(mfrow=c(1,1))

#直方圖
op<-par(mfrow=c(3,2))
plot(data$Gender_f)
plot(data$Credit_Card_f)
plot(data$Loan_f)
plot(data$Saving_f)
plot(data$FM_f)

```


##常態性檢定
```{R}
# 數值資料是否符合常態分配，則可使用常態機率圖或常態性檢定來檢查，以qqnorm函數畫出常態機率圖，再使用qqline畫出最佳斜線，至於常態性檢定則可使用R基本套組stats的shapiro.test函數進行Shapiro-Wilk檢定，或套組nortest的ad.test函數進行Anderson-Darling檢定

# qqnorm(data1$BOA)
# qqline(data1$BOA,col='red')
# shapiro.test(data1$BOA) 
# 檢查是否符合常態分配，p值<0.05拒絕假設其為常態分配的虛無假設

```

##統計分析(卡方,Anova,T-test, or regression)


```{R}
# T檢定主要是檢驗兩組之間是否有差異，條件是有兩組也只能有兩組。組別是類別變數(categorical variable)，像是性別、種族、國籍。如果超過兩組，必須用Anova來分析。

#前、後測是否有顯著差異用paired-sample t-test來檢驗

# One-way Anova(單因子變異數分析)是只有一個類別變數當作independent variable，檢驗此類別變數與其它連續變數(continuous variable)和結果的關係。比方說如果你想看性別、IQ對數學成績的影響，性別就是類別變數，IQ是連續變數，數學成績是結果變數(outcome variable)。

# Two-way Anova(雙因子變異數分析)是有兩個以上的類別變數作為independent variables。比如說性別、種族與IQ對數學成績的影響，性別和種族就是類別變數。

# Anova就是(Linear) Regression，不同點就在Anova裡面有類別變數而已。Linear regression裡的變數均為連續變數或dummy variable

# T-test與Anova比的是平均的差異。卡方測的是在各組發生的比例是否相同。卡方檢定的變數不是連續變數，也不是ordinal variable，而是名目變數(nominal variables，又稱為categorical variable)，也就是「是與否」、「男與女」這種變數。
  



#卡方獨立性檢定-有無理財和有無存款非獨立的(亂測...未抽樣)
summary(table(data1$FM_f[500:9600],data1$Saving_f[500:9600]))
# Number of cases in table: 9101 
# Number of factors: 2 
# Test for independence of all factors:
# 	Chisq = 82, df = 1, p-value = 0.0000000000000000001

#卡方獨立性檢定-是否辦卡和有無貸款非獨立的(亂測...未抽樣)
summary(table(data1$Credit_Card_f[500:9600],data1$Loan_f[500:9600]))
# Number of cases in table: 9101 
# Number of factors: 2 
# Test for independence of all factors:
# 	Chisq = 8, df = 1, p-value = 0.004


```
##Classification

```{R}
```

#c50
```{R}
data1=data1[,-1]
#選擇建模變數
variable.list = !names(data1) %in% c('Comm_Area','Comm_Areacode','House_Area','House_AreaCode','Data_Date')
dataTrain=data1[,variable.list] 
str(dataTrain)


##Decision Tree-C50
install.packages("C50")
library(C50)

set.seed(22)
#把資料分成training data 和 testing data
ind<-sample(1:2, size=nrow(dataTrain), replace=T, prob=c(0.7, 0.3))
trainset=dataTrain[ind==1,]
testset=dataTrain[ind==2,]
table(sample(x = 1:2,size = 1000, replace=T))


```

##rpart
```{R}
install.packages('rpart')
library('rpart')

#重新整理data→把Rev連續型變數轉換成類別變數(O:Rev=0,1:Rev>0)
# RevType[data1$Rev<=0]<-0代表將Rev這個變數小於等於0的類別全部歸類為RevType，並將數值重新編碼為0，以此類推。
RevType<-0
RevType[data1$Rev<=0]<-0
RevType[data1$Rev>0 & data1$Rev<= max(data1$Rev)]<-1

table(RevType)
data1 = cbind.data.frame(data1,RevType)
RevType = factor(RevType)
summary(data1)

#使用rpart(CART)建立決策樹模型
data1.rp<-rpart(data1$RevType_f ~ ., data=trainset)
data1.rp
summary(data1.rp)

con = rpart.control(cp=0.01)
?rpart.control
churn.rp<-rpart(data1$RevType_f ~., data=trainset,control = con)

#畫出決策樹
par(mfrow=c(1,1))
plot(churn.rp, margin=0.1)
plot(churn.rp, uniform=TRUE,branch = 0.6, margin=0.1)
?plot.rpart
text(churn.rp)
text(churn.rp, all=TRUE, use.n=TRUE)

printcp(churn.rp)
plotcp(churn.rp)

```

##階層式分群
```{R}

#數值變數作正規化
data1_s = scale (data1[,-1])
?scale




```

